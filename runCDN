#!/usr/bin/env python
import os
import sys
import threading
import subprocess

DNS_NODE = "p5-dns.5700.network"
HTTP_NODES = ["p5-http-a.5700.network", "p5-http-b.5700.network", "p5-http-c.5700.network",
                "p5-http-d.5700.network", "p5-http-e.5700.network", "p5-http-f.5700.network", "p5-http-g.5700.network"]
BUILD_SERVER = "cs5700cdnproject.ccs.neu.edu"
ORIGIN_SERVER = "cs5700cdnorigin.ccs.neu.edu"

# ./runCDN -p 40015 -o cs5700cdnorigin.ccs.neu.edu -n team_t -u team_t -i ~/.ssh/id_ed25519.pub

def parse_args(args_list):
    #print(args_list)
    port, origin_server, name, username, keyfile = None, None, None, None, None

    for i in range(len(args_list)):
        # print(args_list[i], args_list[i+1])
        if args_list[i] == "-p":
            port = args_list[i + 1]
        elif args_list[i] == "-o":
            origin_server = args_list[i + 1]
        elif args_list[i] == "-n":
            name = args_list[i + 1]
        elif args_list[i] == "-u":
            username = args_list[i + 1]
        elif args_list[i] == "-i":
            keyfile = args_list[i + 1]

    return port, origin_server, name, username, keyfile


def run_dns(port, username, keyfile, domain_name):
    # Run dnsserver.py on dns node
    run_command = (
        "ssh -i "
        + keyfile
        + " "
        + username
        + "@"
        + DNS_NODE
        + " './dnsserver -p "
        + port
        + " -n "
        + domain_name
        + "'"
    )
    os.system(run_command)

def thread_runs(port, username, origin, keyfile):
    threads = []
    for node in HTTP_NODES:
        t = threading.Thread(target=run_http, args=(node, port, username, origin, keyfile))
        t.setDaemon(True)
        threads.append(t)
    
    for t in threads:
        t.start()
        
    for t in threads:
        t.join()

def run_http(node, port, username, origin, keyfile):
    # ssh -i ~/.ssh/id_ed25519.pub team_t@p5-http-d.5700.network './httpserver -p 40015 -o origin'
    # Run httpserver on each replica server
    #for node in HTTP_NODES:
    run_command = (
        "ssh -i "
        + keyfile
        + " "
        + username
        + "@"
        + node
        + " nohup ./httpserver -p "
        + port
        + " -o "
        + origin
        + " &"
    )

    running = os.system(run_command)
    print("Running httpserver on", node, "command returns:", running)
    #subprocess.run(args=run_command, shell=True, check=True)


def main():
    port, origin_server, domain_name, username, keyfile = parse_args(sys.argv[1:])
    print(port, origin_server, domain_name, username, keyfile)

    #run_dns(port, username, keyfile, domain_name)
    thread_runs(port, username, origin_server, keyfile)
    #run_http(port, username, origin_server, keyfile)

main()
